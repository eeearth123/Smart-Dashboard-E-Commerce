import streamlit as st
import pandas as pd
import joblib

# --- 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ---
st.set_page_config(page_title="Olist Churn Prediction", page_icon="üì¶")

st.title("üì¶ Olist Churn Prediction AI")
st.write("‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ (Churn) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà")

# --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏• (‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡πà‡∏á‡∏°‡∏≤) ---
@st.cache_resource
def load_model_objects():
    try:
        # ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå
        model = joblib.load('olist_churn_rf_model')
        features = joblib.load('model_features')
        return model, features
    except FileNotFoundError as e:
        return None, None

# ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î
loaded_model, model_features = load_model_objects()

# --- 3. ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏•‡∏±‡∏Å ---
if loaded_model is None or model_features is None:
    st.error("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÇ‡∏°‡πÄ‡∏î‡∏•! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÑ‡∏ü‡∏•‡πå 'olist_churn_rf_model.pkl' ‡πÅ‡∏•‡∏∞ 'model_features.pkl' ‡∏ß‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö app.py ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á?")
else:
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á Sidebar ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡∏°‡∏≤)
    st.sidebar.header("üìù ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤")
    
    # ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÜ (‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á sample_input ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
    freight_value_mean = st.sidebar.number_input("‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (Freight Value)", value=35.5)
    delivery_days_mean = st.sidebar.number_input("‡∏£‡∏≠‡∏Ç‡∏≠‡∏á‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô (Avg Delivery Days)", value=15.0)
    delay_days_mean = st.sidebar.number_input("‡∏™‡πà‡∏á‡∏ä‡πâ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô (Avg Delay Days)", value=2.0)
    delivery_days_max = st.sidebar.number_input("‡∏£‡∏≠‡∏ô‡∏≤‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô (Max Delivery Days)", value=20.0)
    
    # ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤
    shipping_cost_per_gram = st.sidebar.number_input("‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏Å‡∏£‡∏±‡∏°", value=0.05, format="%.4f")
    product_weight_g_mean = st.sidebar.number_input("‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (g)", value=500.0)
    freight_ratio_mean = st.sidebar.number_input("‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á (Freight Ratio)", value=0.15)
    avg_basket_value = st.sidebar.number_input("‡∏¢‡∏≠‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏ï‡πà‡∏≠‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢", value=120.0)
    
    # ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°
    is_high_freight_customer = st.sidebar.selectbox("‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á‡πÅ‡∏û‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?", options=[0, 1], index=1)
    price_mean = st.sidebar.number_input("‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢", value=100.0)
    monetary_value = st.sidebar.number_input("‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏° (Monetary)", value=500.0)
    product_photos_qty_mean = st.sidebar.number_input("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏π‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢", value=2.0)
    
    # ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ä‡πâ‡∏≤
    total_late_orders = st.sidebar.number_input("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏ä‡πâ‡∏≤", value=1)
    min_review_score = st.sidebar.slider("‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î", 1, 5, 4)
    avg_review_score = st.sidebar.slider("‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢", 1.0, 5.0, 4.5)

    # --- 4. ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢ ---
    if st.button("üîÆ ‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏ú‡∏• (Predict)"):
        # ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤ DataFrame
        input_data = pd.DataFrame([{
            'freight_value_mean': freight_value_mean,
            'delivery_days_mean': delivery_days_mean,
            'delay_days_mean': delay_days_mean,
            'delivery_days_max': delivery_days_max,
            'shipping_cost_per_gram': shipping_cost_per_gram,
            'product_weight_g_mean': product_weight_g_mean,
            'freight_ratio_mean': freight_ratio_mean,
            'avg_basket_value': avg_basket_value,
            'is_high_freight_customer': is_high_freight_customer,
            'price_mean': price_mean,
            'monetary_value': monetary_value,
            'product_photos_qty_mean': product_photos_qty_mean,
            'total_late_orders': total_late_orders,
            'min_review_score': min_review_score,
            'avg_review_score': avg_review_score
        }])

        try:
            # ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ï‡∏≠‡∏ô‡πÄ‡∏ó‡∏£‡∏ô‡πÄ‡∏õ‡πä‡∏∞‡πÜ
            input_data = input_data[model_features]
            
            # ‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡∏ú‡∏•
            prediction = loaded_model.predict(input_data)[0]
            prob = loaded_model.predict_proba(input_data)[0][1] # ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÄ‡∏Å‡∏¥‡∏î Class 1 (Churn)

            # ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
            st.markdown("---")
            if prediction == 1:
                st.error(f"‚ö†Ô∏è **‡∏ú‡∏•‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢: ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏°‡∏µ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏à‡∏∞‡∏´‡∏ô‡∏µ (Churn)**")
                st.write(f"‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏Ç‡∏≠‡∏á‡πÇ‡∏°‡πÄ‡∏î‡∏•: **{prob*100:.2f}%**")
            else:
                st.success(f"‚úÖ **‡∏ú‡∏•‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢: ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà (Stay)**")
                st.write(f"‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏´‡∏ô‡∏µ‡πÄ‡∏û‡∏µ‡∏¢‡∏á: **{prob*100:.2f}%**")

        except Exception as e:
            st.error(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢: {e}")

            st.info("‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏•‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÑ‡∏ü‡∏•‡πå model_features.pkl ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡∏£‡∏ô‡∏°‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà")
